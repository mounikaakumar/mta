<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile UI Automation Release Execution OKRs</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px 40px;
    background: #fff;
    color: #000;
  }

  header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    margin-bottom: 5px;
  }

  h1 {
    border: 1px solid black;
    padding: 10px;
    text-align: center;
    font-weight: 700;
  }

    /* Sync Status Banner */
        .sync-status-banner {
            position: sticky;
            top: 0;
            z-index: 1000;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .sync-status-banner.sync-in-progress {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            border: 1px solid #ff9ff3;
        }
        
        .sync-status-banner.sync-completed {
            background: linear-gradient(135deg, #48cae4 0%, #0077b6 100%);
            border: 1px solid #90e0ef;
        }
        
        .sync-banner-content {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            color: white;
        }
        
        .sync-indicator {
            margin-right: 16px;
            position: relative;
        }
        
        .sync-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            top: -6px;
            left: -6px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sync-icon {
            font-size: 20px;
            display: block;
            z-index: 1;
            position: relative;
        }
        
        .sync-message {
            flex: 1;
        }
        
        .sync-title {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .sync-description {
            margin: 0 0 8px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .sync-progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .sync-progress-fill {
            height: 100%;
            background: white;
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .sync-details {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .sync-detail-item {
            margin-right: 16px;
        }
        
        .sync-banner-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .sync-banner-close:hover {
            background-color: rgba(255,255,255,0.2);
        }

  .filters {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 160px;
  }

  .filter-group label {
    font-weight: 600;
    margin-bottom: 6px;
    color: #004a99;
  }

  select, input[type="date"], .modern-clear-btn {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1.8px solid #aaa;
    background: #eee;
    font-weight: 600;
    cursor: pointer;
    transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
    text-align: center;
  }

  select:hover, input[type="date"]:hover, select:focus, input[type="date"]:focus,
  .modern-clear-btn:hover {
    transform: scale(1.05);
    border-color: #0056b3;
    box-shadow: 0 0 12px rgba(0, 86, 179, 0.5);
    background: #f0f8ff;
    outline: none;
  }

  .modern-clear-btn {
    margin-top: 6px;
    background: #007BFF;
    color: white;
    font-weight: 700;
    border: none;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.3s ease, transform 0.25s ease;
  }

  .modern-clear-btn:hover {
    background-color: #0056b3;
  }

  .date-range-group {
    min-width: 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .modern-date-container {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
  }

  .modern-date-container > div {
    display: flex;
    flex-direction: column;
  }

  .modern-date-container div div {
    font-size: 12px;
    color: #004a99;
    text-align: center;
    margin-top: 3px;
    font-weight: 600;
  }

/* Filters Card with vertical scroll */
/* Filters Card - wider and more flexible */
.filters-card {
  max-width: 1500px;       /* increased width */
  margin: 30px auto;
  padding: 25px 30px;
  background: #f8faff;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);

  max-height: 400px;       /* max height to contain filters */
  min-height: 200px;       /* minimum height */
  overflow-y: auto;        /* scroll if content overflows vertically */
}

/* Filters Grid - 2 rows if needed */
.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* wider min size */
  gap: 20px 25px; /* space between filters */
  justify-content: center;
  align-items: center;
}



/* Date Range input wider */
.filters-card input[type="text"] {
  min-width: 200px; /* ensures visibility */
  padding: 10px;
}

/* Clear button */
.modern-clear-btn {
  margin-top: 8px;
  background: #007BFF;
  color: white;
  font-weight: 700;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  padding: 10px 15px;
  transition: background-color 0.3s ease, transform 0.25s ease;
}

.modern-clear-btn:hover {
  background-color: #0056b3;
  transform: scale(1.05);
}


/* Filters Form Animation */
.filters form#filterForm {
  opacity: 0;
  transform: translateY(25px);
  animation: fadeSlideIn 0.6s forwards ease-out;
  animation-delay: 0.3s;
}

@keyframes fadeSlideIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


  .view-title {
    text-align: center;
    font-weight: 700;
    margin: 15px 0 10px;
    font-size: 16px;
    text-decoration: underline;
    color: #004a99;
  }

  table {
    border-collapse: collapse;
    margin: 0 auto 30px auto;
    width: 950px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 12px 18px;
    text-align: center;
    font-weight: 600;
  }

  th {
    background-color: #007BFF;
    color: white;
  }

  tbody tr {
    transition: background-color 0.4s ease;
  }

  tbody tr:hover {
    background-color: #dbe9ff;
  }

  td.left-label {
    text-align: right;
    font-weight: 700;
    width: 160px;
    padding-right: 12px;
    background: #f7f9fc;
  }

  td.count {
    font-size: 22px;
    font-weight: 700;
    color: #003366;
  }

  td.percent {
    font-weight: 600;
    color: #0056b3;
  }

  .breakdown {
    display: flex;
    justify-content: center;
    margin-top: 12px;
    gap: 12px;
  }

  .breakdown-box {
    border: 1.5px solid #007BFF;
    width: 110px;
    padding: 12px 8px;
    font-size: 14px;
    border-radius: 6px;
    background: #e6f0ff;
    cursor: default;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .breakdown-box:hover {
    transform: scale(1.07);
    box-shadow: 0 8px 18px rgba(0, 123, 255, 0.35);
  }

  .breakdown-box strong {
    display: block;
    font-size: 20px;
    font-weight: 900;
    color: #003366;
  }

  .breakdown-label {
    font-weight: 500;
    font-size: 12px;
    color: #004a99;
    margin-top: 4px;
  }

  .arrow {
    border-top: 2px dashed #007BFF;
    border-right: 2px dashed #007BFF;
    width: 20px;
    height: 20px;
    margin: auto 10px;
    transform: rotate(45deg);
  }

  .container-flex {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
  }

  .pass-rate-section {
  max-width: 2400px;
  margin: 30px auto;
  padding: 10px 20px;
}

.pass-rate-header {
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 20px;
  color: #004a99;
  text-decoration: underline;
}

.pass-rate-tables {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
}

.pass-rate-card {
  background: #f8faff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.pass-rate-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.pass-rate-card .table-title {
  font-size: 18px;
  font-weight: 700;
  color: #004a99;
  margin-bottom: 12px;
  text-align: center;
}

.neat-breakdown-table {
  width: 100%;
  border-collapse: collapse;
}

.neat-breakdown-table th, .neat-breakdown-table td {
  border: 1px solid #ddd;
  padding: 10px 14px;
  text-align: center;
  font-weight: 600;
}

.neat-breakdown-table th {
  background-color: #007BFF;
  color: white;
}

.passrate-section {
  margin: 0 auto;
  max-width: 2300px;
  text-align: center;
  height: 500px;              /* Add fixed height */
  overflow: hidden;           /* Prevent outer scroll */
  display: flex;
  flex-direction: column;
}

/* Flex row of tables */
.tables-row {
  display: flex;
  flex: 1;                    /* Fill available vertical space */
  gap: 24px;
  justify-content: flex-start;
  align-items: stretch;       /* Force children to same height */
  margin-top: 30px;
  overflow: hidden;           /* Prevent wrapping */
}

/* Left table card container */
.table-card {
  flex: 1 1 48%;
  max-width: 600px;
  min-width: 350px;
  background: #f8faff;
  padding: 0;                 /* Remove internal padding for full-height table */
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Inner scrollable container (table wrapper) */
.table-scroll {
  flex: 1;                    /* Fill remaining space */
  overflow-y: auto;
}

/* Table styling */
.table-scroll table {
  width: 100%;
  table-layout: fixed;
  border-collapse: collapse;
}

.table-scroll td,
.table-scroll th {
  height: 50px;               /* Fixed height ensures row alignment */
  padding: 8px;
  border-bottom: 1px solid #ccc;
  text-align: left;
}

.table-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.15);
}

/* Right table container (wrap the form with this class) */
.test-method-container {
  flex: 1 1 48%;
  max-width: 800px;
  min-width: 450px;
  background: #f8faff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  overflow-x: auto; /* horizontal scroll if needed */
}

/* Header inside test method section */
.test-method-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  font-weight: 700;
  color: #007BFF;
  font-size: 18px;
}

/* Filter select styling consistent with existing */
.test-method-header select.filter-select {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1.8px solid #aaa;
  background: #eee;
  font-weight: 600;
  cursor: pointer;
  transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
  text-align: center;
}

.test-method-header select.filter-select:hover,
.test-method-header select.filter-select:focus {
  transform: scale(1.05);
  border-color: #0056b3;
  box-shadow: 0 0 12px rgba(0, 86, 179, 0.5);
  background: #f0f8ff;
  outline: none;
}

/* Custom table styling inside test method container */
.custom-table {
  width: 100%; /* Make the table width take up the full container */
  table-layout: fixed; /* This will allow columns to take up their allocated space without overflowing */
  border-collapse: collapse;
}

.table-header-row,
.table-row {
  display: flex;
  border-bottom: 1px solid #ddd;
  width: 100%;
}

.table-header-row {
  background-color: #007BFF;
  color: white;
  font-weight: 700;
}

.table-header-cell,
.table-cell {
  flex: 1;
  padding: 12px 15px;
  word-break: break-word;
  text-align: center;
}

.table-header-cell:first-child,
.table-cell.test-method-name {
  flex: 2; /* wider column for names */
}

/* Pagination styles */
.table-pagination {
  margin-top: 20px;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pagination-controls a,
.pagination-controls button {
  margin-left: 10px;
  color: #007BFF;
  cursor: pointer;
  text-decoration: none;
  background: none;
  border: none;
  font-size: 16px;
}

.pagination-controls button[disabled] {
  color: #999;
  cursor: not-allowed;
}

/* Responsive for smaller screens */
@media (max-width: 800px) {
  .tables-row {
    flex-wrap: wrap;
  }

  .table-card, .test-method-container {
  flex: 1 1 48%; /* Flexibly occupy available space */
  max-width: 100%; /* Allow container to occupy the full width */
  min-width: 350px;
}
}



  /* Spinner overlay with fade */
  #spinnerOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  #spinnerOverlay.active {
    opacity: 1;
    visibility: visible;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 6px solid #93c5fd;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

.header-container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      margin-bottom: 10px;
    }

    h1.main-title {
      border: 1px solid black;
      padding: 12px 24px;
      margin: 0;
      font-size: 1.8rem;
      font-weight: bold;
      white-space: nowrap;
    }

    .copy-link {
      position: absolute;
      right: 20px; /* space from right edge */
      top: 50%;
      transform: translateY(-50%);
    }

    #copyLinkBtn {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 14px;
      color: #333;
      transition: background-color 0.2s ease;
    }

    #copyLinkBtn:hover {
      background-color: #e0e0e0;
    }

    .build-level-view-container {
      text-align: center;
      margin-top: 20px; /* spacing from title */
    }

    .build-level-view {
      color: #004080;
      font-weight: bold;
      font-size: 1rem;
      text-transform: uppercase;
    }



</style>
</head>
<body>


    <div class="container">
        <!-- Sync Status Banner -->
        {% if is_sync_in_progress %}
        <div id="syncStatusBanner" class="sync-status-banner sync-in-progress">
            <div class="sync-banner-content">
                <div class="sync-indicator">
                    <div class="sync-spinner"></div>
                    <span class="sync-icon">🔄</span>
                </div>
                <div class="sync-message">
                    <h4 class="sync-title">Data Sync in Progress</h4>
                    <p class="sync-description">Backend is updating data from Presto. Dashboard may load slower than usual.</p>
                    <div class="sync-progress-bar">
                        <div class="sync-progress-fill" id="syncProgressFill"></div>
                    </div>
                    <div class="sync-details" id="syncDetails">
                        {% if sync_status %}
                            {% for status in sync_status %}
                                <span class="sync-detail-item">{{ status.sync_type }}: {{ status.message or 'In progress...' }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                <button type="button" class="sync-banner-close" onclick="closeSyncBanner()">×</button>
            </div>
        </div>
        {% else %}
        <div id="syncStatusBanner" class="sync-status-banner sync-completed" style="display: none;">
            <!-- Completed sync banner removed - only show when sync is in progress -->
        </div>
        {% endif %}
<div class="last-updated">
                        Last updated: <span id="lastUpdated">{{timestamp}}</span> UTC
                    </div>
       
                    <div class="status-indicator {{ 'status-syncing' if is_sync_in_progress else 'status-ready' }}">
                        <span class="status-dot"></span>
                        <span class="status-text">{{ 'Syncing Data' if is_sync_in_progress else 'Dashboard up to date and Ready' }}</span>
                    </div>
</div>


<div class="header-container">
    <h1 class="main-title">Mobile UI Automation Release Execution OKRs</h1>
    <div class="copy-link">
      <button id="copyLinkBtn">📋 Copy Shareable Link</button>
    </div>
  </div>

  <div class="build-level-view-container">
    <div class="build-level-view">BUILD LEVEL VIEW</div>
  </div>

<!-- Filters inside form -->
<!-- Filters Container -->

<div class="filters-card">
  <form id="filterForm" method="GET">
    <div class="filters-grid">
      
      <!-- Release Version -->
      <div class="filter-group">
        <label for="latest_release">Release Version</label>
        <select id="latest_release" name="latest_release" class="filter-select" multiple>
          <option value="" disabled hidden>All Releases</option>
          {% for val in latest_release %}
          <option value="{{ val[0] }}" 
            {% if val[0] in request.args.getlist('latest_release') %}selected{% endif %}>
            {{ val[0] }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Build Version -->
      <div class="filter-group">
        <label for="build_version">Build Version</label>
        <select id="build_version" name="build_version" class="filter-select" multiple>
          <option value="" disabled hidden>All Builds</option>
          {% for val in build_version %}
          <option value="{{ val[0] }}" 
            {% if val[0] in request.args.getlist('build_version') %}selected{% endif %}>
            {{ val[0] }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- LOB -->
      <div class="filter-group">
        <label for="lob">Line of Business</label>
        <select id="lob" name="lob" class="filter-select" multiple>
          <option value="" disabled hidden>All LOBs</option>
          {% for val in lob %}
          <option value="{{ val[0] }}" 
            {% if val[0] in request.args.getlist('lob') %}selected{% endif %}>
            {{ val[0] }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- App Platform -->
      <div class="filter-group">
        <label for="app_platform">App Platform</label>
        <select id="app_platform" name="app_platform" class="filter-select" multiple>
          <option value="" disabled hidden>All Platforms</option>
          {% for val in app_platform %}
          <option value="{{ val[0] }}" 
            {% if val[0] in request.args.getlist('app_platform') %}selected{% endif %}>
            {{ val[0] }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- OS Version -->
      <div class="filter-group">
        <label for="os_version">OS Version</label>
        <select id="os_version" name="os_version" class="filter-select" multiple>
          <option value="" disabled hidden>All OS Versions</option>
          {% for val in os_version %}
          <option value="{{ val[0] }}" 
            {% if val[0] in request.args.getlist('os_version') %}selected{% endif %}>
            {{ val[0] }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Date Range -->
      <div class="filter-group date-range-group">
        <label for="date_range">📅 Date Range</label>
        <div class="modern-date-container">
          <input type="text" id="date_range" placeholder="Select date range" />
          <button type="button" id="clearDates" class="modern-clear-btn" title="Clear dates">Clear</button>
        </div>
        <input type="hidden" id="start_date" name="start_date">
        <input type="hidden" id="end_date" name="end_date">
      </div>

    </div>
    <!-- Hidden sync container to include multi-selects from other forms -->
    <div id="hiddenMultiFilters"></div>
    <div style="margin-top:12px; text-align:center;">
      <button type="button" id="resetAllFilters" class="modern-clear-btn" title="Reset all filters" style="background:#6c757d;">Reset All Filters</button>
    </div>
    <!-- Hidden pagination fields to preserve filters across pages -->
    <input type="hidden" id="feature_page" name="feature_page" value="{{ request.args.get('feature_page', feature_current_page) }}">
    <input type="hidden" id="test_method_page" name="test_method_page" value="{{ request.args.get('test_method_page', test_method_current_page) }}">
    <input type="hidden" id="bug_page" name="bug_page" value="{{ request.args.get('bug_page', bug_current_page) }}">
  </form>
</div>



<table>
  <thead>
    <tr>
      <th></th>
      <th><u>Count</u></th>
      <th><u>Percentage</u></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left-label"># Tests</td>
      <td class="count">{{ "{:,}".format(tests) if tests else 0 }}</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label"># Test Methods</td>
      <td class="count">{{ "{:,}".format(test_methods) if test_methods else 0 }}</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label"># Runs</td>
      <td class="count">{{ "{:,}".format(runs) if runs else 0 }}</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label"># Passed Runs</td>
      <td class="count">{{ "{:,}".format(passed_runs) if passed_runs else 0 }}</td>
      <td class="percent">{{ pass_rate if pass_rate else '0.0' }}</td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label"># Failed Runs</td>
      <td class="count">{{ "{:,}".format(fail) if fail else 0 }}</td>
      <td class="percent">{{ fail_rate if fail_rate else '0.0' }}</td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label"># PB Failures</td>
      <td class="count">{{ "{:,}".format(product_bugs) if product_bugs else 0 }}</td>
      <td class="percent">{{ pb_perc if pb_perc else '0.0' }}</td>
      <td class="container-flex">
        <div class="arrow"></div>
        <div class="breakdown">
          <div class="breakdown-box">
            <div class="breakdown-label">One time</div>
            <strong>{{ one_time if one_time else 0 }}</strong>
            <div class="breakdown-label small">{{ one_time_p if one_time_p else '0.0' }}</div>
          </div>
          <div class="breakdown-box">
            <div class="breakdown-label">Intermittent</div>
            <strong>{{ intermittent }}</strong>
            <div class="breakdown-label small">{{ intermittent_pct }}%</div>
          </div>
          <div class="breakdown-box">
            <div class="breakdown-label">Always</div>
            <strong>{{ always }}</strong>
            <div class="breakdown-label small">{{ always_pct }}%</div>
          </div>
           <div class="breakdown-box">
            <div class="breakdown-label">PPB Failures</div>
            <strong>{{ PPB_failures }}</strong>
            <div class="breakdown-label small">{{ ppb_p }}</div>
          </div>
        </div>
      </td>
    </tr>
    <tr>
      <td class="left-label"># PFC Failures</td>
      <td class="count">{{ "{:,}".format(pc_failure) if pc_failure else 0 }}</td>
      <td class="percent">{{ pc_failure_p if pc_failure_p else '0.0' }}</td>
      <td class="container-flex">
        <div class="arrow"></div>
        <div class="breakdown">
          <div class="breakdown-box">
            <div class="breakdown-label">Flow Change</div>
            <strong>{{ flow_change }}</strong>
            <div class="breakdown-label small">{{ flow_change_pct }}</div>
          </div>
          <div class="breakdown-box">
            <div class="breakdown-label">Identifier</div>
            <strong>{{ identifier }}</strong>
            <div class="breakdown-label small">{{ identifier_pct }}</div>
          </div>
          <div class="breakdown-box">
            <div class="breakdown-label">Others</div>
            <strong>{{ others }}</strong>
            <div class="breakdown-label small">{{ others_pct }}</div>
          </div>
        </div>
      </td>
    </tr>
    <tr>
      <td class="left-label"># TSF Failures</td>
      <td class="count">{{ "{:,}".format(t_script_failure) if t_script_failure else 0 }}</td>
      <td class="percent">{{ t_script_failure_p if t_script_failure_p else '0.0' }}</td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label"># Infra Failures</td>
      <td class="count">{{ "{:,}".format(infra_runs_new) if infra_runs_new else 0 }}</td>
      <td class="percent">{{ infra_runs_new_p if infra_runs_new_p else '0.0' }}</td>
      <td class="container-flex">
        <div class="arrow"></div>
        <div class="breakdown">
          <div class="breakdown-box" style="width: 90px;">
            <div class="breakdown-label">occurrence</div>
            <strong>{{ occurrence }}</strong>
            <div class="breakdown-label small">{{ occurrence_pct }}%</div>
          </div>
          <div class="breakdown-box" style="width: 110px;">
            <div class="breakdown-label">no_of_masked_infra_runs</div>
            <strong>{{ no_of_masked_infra_runs }}</strong>
            <div class="breakdown-label small">{{ no_of_masked_infra_runs }}%</div>
          </div>
        </div>
      </td>
    </tr>
    <tr>
      <td class="left-label"># Untriaged Failures</td>
      <td class="count">{{ "{:,}".format(u1) if u1 else 0 }}</td>
      <td class="percent">{{ u1_p if u1_p else '0.0' }}</td>
      <td></td>
    </tr>
    <tr>
      <td class="left-label">Unclassified</td>
      <td class="count">{{ "{:,}".format(unclassified_failure) if unclassified_failure else 0 }}</td>
      <td class="percent">{{ unclassified_failure_p if unclassified_failure_p else '0.0' }}</td>
      <td></td>
    </tr>
     <tr>
      <td class="left-label">Device Lab</td>
      <td class="count">{{ "{:,}".format(dl_failures) if dl_failures else 0 }}</td>
      <td class="percent">{{ dl_failures_p if dl_failures_p else '0.0' }}</td>
      <td></td>
    </tr>
  </tbody>
</table>




 <!-- Pass Rate Analysis Section -->
<div class="pass-rate-section">
  <h2 class="pass-rate-header">📈 Pass Rate Analysis</h2>

  <div class="pass-rate-tables">
    <!-- LOB Wise Table -->
    <div class="pass-rate-card">
      <h3 class="table-title">🏢 LOB Wise Pass Rate</h3>
      <table class="neat-breakdown-table">
        <thead>
          <tr>
            <th>LOB</th>
            <th>Pass Rate (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for item in lob_breakdown %}
          <tr>
            <td>{{ item.lob }}</td>
            <td>{{ item.pass_rate }}</td>
          </tr>
          {% endfor %}
          {% if not lob_breakdown %}
          <tr><td colspan="2">No data available</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- App Platform Wise Table -->
    <div class="pass-rate-card">
      <h3 class="table-title">📱 App Platform Wise Pass Rate</h3>
      <table class="neat-breakdown-table">
        <thead>
          <tr>
            <th>Platform</th>
            <th>Pass Rate (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for item in platform_breakdown %}
          <tr>
            <td>{{ item.platform }}</td>
            <td>{{ item.pass_rate }}</td>
          </tr>
          {% endfor %}
          {% if not platform_breakdown %}
          <tr><td colspan="2">No data available</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>




<!-- 🔬 Detailed Pass Rate Analysis Section -->
<div class="pass-rate-section">
  <h2 class="pass-rate-header">📊 Detailed Pass Rate Analysis</h2>

  <div class="pass-rate-tables">
    <!-- Feature Wise Pass Rate -->
    <div class="pass-rate-card">
      <h3 class="table-title">🎯 Feature Wise Pass Rate</h3>
      
      <!-- Feature Filter Form -->
      <form id="featureForm" method="GET" action="" onsubmit="syncAndSubmitToMain(event)">
        <label for="scenarioname"><strong>Filter by Feature:</strong></label>
        <select id="scenarioname" name="scenarioname" class="filter-select" multiple onchange="syncAndSubmitToMain(event)" style="margin-top: 8px; margin-bottom: 16px; padding: 6px 10px; font-size: 14px;">
          <option value="" disabled hidden>All Features</option>
          {% for val in scenarioname %}
            <option value="{{ val }}" {% if val in request.args.getlist('scenarioname') %}selected{% endif %}>
              {{ val }}
            </option>
          {% endfor %}
        </select>
      </form>

      <table class="neat-breakdown-table">
        <thead>
          <tr>
            <th>Feature</th>
            <th>Bugs</th>
            <th>Pass Rate (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in feature_breakdown %}
          <tr>
            <td>{{ row.feature }}</td>
            <td>{{ row.bugs }}</td>
            <td>{{ row.pass_rate }}%</td>
          </tr>
          {% endfor %}
          {% if not feature_breakdown %}
          <tr><td colspan="3">No data available</td></tr>
          {% endif %}
        </tbody>
      </table>




        <!-- Feature Pagination -->
<div class="table-pagination">
  <span>Page {{ feature_current_page if feature_pages else 0 }} of {{ feature_pages }}</span>
  <div class="pagination-controls">
    {% if feature_current_page > 1 %}
      <button type="button" class="pagination-btn" data-target-page="{{ feature_current_page - 1 }}" data-page-type="feature_page">« Prev</button>
    {% endif %}
    {% if feature_current_page < feature_pages %}
      <button type="button" class="pagination-btn" data-target-page="{{ feature_current_page + 1 }}" data-page-type="feature_page">Next »</button>
    {% endif %}
  </div>
</div>
</div> 

    <!-- Test Method Wise Pass Rate -->
    <div class="pass-rate-card">
      <h3 class="table-title">🧪 Test Method Wise Pass Rate</h3>
      
      <form id="testMethodForm" method="GET" onsubmit="syncAndSubmitToMain(event)">
        <label for="test_case"><strong>Filter by Test Method:</strong></label>
        <select 
          id="test_case"
          name="test_case"
          class="filter-select"
          multiple
          onchange="syncAndSubmitToMain(event)"
          style="margin-top: 8px; margin-bottom: 16px; padding: 6px 10px; font-size: 14px; width: 100%; max-width: 100%;"
        >
          {% for val in test_case %}
            <option value="{{ val[0] }}" {% if val[0] in request.args.getlist('test_case') %}selected{% endif %}>
              {{ val[0] }}
            </option>
          {% endfor %}
        </select>
      </form>

      <table class="neat-breakdown-table">
        <thead>
          <tr>
            <th>Test Method</th>
            <th>Pass Rate (%)</th>
            <th># Bugs</th>
          </tr>
        </thead>
        <tbody>
          {% for item in test_method_breakdown %}
          <tr>
            <td style="word-break: break-word;">{{ item.test_method }}</td>
            <td>{{ item.pass_rate }}</td>
            <td>{{ item.bugs }}</td>
          </tr>
          {% endfor %}
          {% if not test_method_breakdown %}
          <tr><td colspan="3">No data available</td></tr>
          {% endif %}
        </tbody>
      </table>


      <div class="table-pagination">
  <span>Page {{ test_method_current_page if test_method_pages else 0 }} of {{ test_method_pages }}</span>
  <div class="pagination-controls">
    {% if test_method_current_page > 1 %}
      <button type="button" class="pagination-btn" data-target-page="{{ test_method_current_page - 1 }}" data-page-type="test_method_page">« Prev</button>
    {% endif %}
    {% if test_method_current_page < test_method_pages %}
      <button type="button" class="pagination-btn" data-target-page="{{ test_method_current_page + 1 }}" data-page-type="test_method_page">Next »</button>
    {% endif %}
  </div>
</div>

    </div>
  </div>
</div>
</body>

<style>
/* General Font */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Bug Filters Layout */
.bug-filters-section {
    margin-top: 20px;
}

.bug-filters-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: flex-start;
}

.bug-filter-select {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    min-width: 180px;
}

/* Table Container */
.bug-table-container {
    overflow-x: auto;
    max-width: 100%;
    padding: 10px 0;
}

/* Table Wrapper */
.bug-table-wrapper {
    width: 100%;
    overflow-x: auto;
}

/* Bug Table */
.bug-table {
    min-width: 1200px;
    width: 100%;
    border-collapse: collapse;
    font-size: 0.92rem;
    table-layout: fixed;
}

/* Header Row */
.bug-table-header {
    background-color: #007bff;
    color: white;
}

/* Table Header and Cell */
.bug-table-th,
.bug-table-cell {
    padding: 12px 10px;
    border: 1px solid #ddd;
    text-align: center;
    vertical-align: middle;
    word-wrap: break-word;
}

/* Column Widths */
.bug-table-th:nth-child(1),
.bug-table-cell:nth-child(1) { width: 80px; }   /* bug_id */
.bug-table-th:nth-child(2),
.bug-table-cell:nth-child(2) { width: 120px; }  /* JIRA Project */
.bug-table-th:nth-child(3),
.bug-table-cell:nth-child(3) { width: 120px; }  /* Project Category */
.bug-table-th:nth-child(4),
.bug-table-cell:nth-child(4) { width: 120px; }  /* Build Version */
.bug-table-th:nth-child(5),
.bug-table-cell:nth-child(5) { width: 90px; }   /* Occurrence */
.bug-table-th:nth-child(6),
.bug-table-cell:nth-child(6) { width: 100px; }  /* Status */
.bug-table-th:nth-child(7),
.bug-table-cell:nth-child(7) { width: 100px; }  /* Priority */
.bug-table-th:nth-child(8),
.bug-table-cell:nth-child(8) { width: 180px; text-align: left; padding-left: 10px; }  /* Test Case */
.bug-table-th:nth-child(9),
.bug-table-cell:nth-child(9) { width: 100px; }  /* Age */
.bug-table-th:nth-child(10),
.bug-table-cell:nth-child(10) { width: 120px; } /* Platform */
.bug-table-th:nth-child(11),
.bug-table-cell:nth-child(11) { width: 120px; } /* l1 Category */
.bug-table-th:nth-child(12),
.bug-table-cell:nth-child(12) { width: 80px; }  /* OOSLA? */
.bug-table-th:nth-child(13),
.bug-table-cell:nth-child(13) { width: 90px; }  /* Failures */

/* Row Alternating Colors */
.bug-table-body tr:nth-child(even) {
    background-color: #f9f9f9;
}

.bug-table-body tr:hover {
    background-color: #eef5ff;
    transition: background 0.3s ease;
}

/* Status Colors */
.status-closed {
    color: green;
    font-weight: bold;
}
.status-open {
    color: #d9534f;
    font-weight: bold;
}
.status-in-progress {
    color: #f0ad4e;
    font-weight: bold;
}

/* Priority Styling */
.priority-p1,
.priority-p0 {
    color: red;
    font-weight: bold;
}
.priority-p2 {
    color: orange;
}
.priority-p3 {
    color: gray;
}

/* OOSLA */
.oosla-yes {
    background-color: #ffe5e5;
    color: #cc0000;
    font-weight: bold;
}
.oosla-no {
    color: green;
}

/* Pagination Style */
.table-pagination {
    margin-top: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
}

.pagination-controls a {
    color: #007bff;
    text-decoration: none;
    margin: 0 4px;
}

.pagination-controls a:hover {
    text-decoration: underline;
}

/* Responsive Improvements */
@media (max-width: 768px) {
    .bug-filters-grid {
        flex-direction: column;
        gap: 10px;
    }

    .bug-table {
        font-size: 0.85rem;
    }

    .bug-table-th,
    .bug-table-cell {
        padding: 8px 6px;
    }

    .bug-table-th:nth-child(8),
    .bug-table-cell:nth-child(8) {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
}
</style>

<!-- Bug Level View Section -->
<div class="bug-level-section">
    <!-- Header -->
   <div class="bug-level-header" style="text-align: center;">
        <h3 class="section-title bug-title" style="font-size: 36px; font-weight: bold; text-align: center; margin: 20px 0;">
            <span class="section-icon">🐛</span>
            BUG LEVEL VIEW
        </h3>
    </div>
        <p class="bug-subtitle">Please click on the test methods to get the bugs associated with those test methods</p>
    </div>

    <!-- Filters -->
    <div class="bug-filters-section">
        <h4 class="bug-report-title">Bug Report</h4>
        <form id="bugfilterForm" method="GET" action="">
           <div class="bug-filters-grid">
    <div class="bug-filter-group">
        <!-- Project Category -->
        <select id="project_category_name" name="project_category_name" class="bug-filter-select">
            <option value="">Project Category</option>
            {% for val in project_category_name %}
                <option value="{{ val[0] }}" 
                    {% if request.args.get('project_category_name') == val[0] %}selected{% endif %}>
                    {{ val[0] }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="bug-filter-group">
        <!-- JIRA Project -->
        <select id="project_name" name="project_name" class="bug-filter-select">
            <option value="">JIRA Project</option>
            {% for val in project_name %}
                <option value="{{ val[0] }}" 
                    {% if request.args.get('project_name') == val[0] %}selected{% endif %}>
                    {{ val[0] }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="bug-filter-group">
        <!-- Build Version -->
        <select id="bug_build_version" name="build_version" class="bug-filter-select">
            <option value="">All Builds</option>
            {% for val in build_version %}
                <option value="{{ val[0] }}" 
                    {% if request.args.get('build_version') == val[0] %}selected{% endif %}>
                    {{ val[0] }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="bug-filter-group">
        <!-- l1 category -->
        <select id="l1_category" name="l1_category" class="bug-filter-select">
            <option value="">L1 Category</option>
            {% for val in l1_category %}
                <option value="{{ val[0] }}" 
                    {% if request.args.get('l1_category') == val[0] %}selected{% endif %}>
                    {{ val[0] }}
                </option>
            {% endfor %}
        </select>
    </div>
    <!-- Persist all active dashboard filters so selections aren't lost -->
    <input type="hidden" name="latest_release" value="{{ request.args.get('latest_release', '') }}">
    <input type="hidden" name="build_version" value="{{ request.args.get('build_version', '') }}">
    <input type="hidden" name="lob" value="{{ request.args.get('lob', '') }}">
    <input type="hidden" name="app_platform" value="{{ request.args.get('app_platform', '') }}">
    <input type="hidden" name="os_version" value="{{ request.args.get('os_version', '') }}">
    <input type="hidden" name="project_name" value="{{ request.args.get('project_name', '') }}">
    <input type="hidden" name="project_category_name" value="{{ request.args.get('project_category_name', '') }}">
    <input type="hidden" name="scenarioname" value="{{ request.args.get('scenarioname', '') }}">
    <input type="hidden" name="test_case" value="{{ request.args.get('test_case', '') }}">
    <input type="hidden" name="l1_category" value="{{ request.args.get('l1_category', '') }}">
    <input type="hidden" name="start_date" value="{{ request.args.get('start_date', '') }}">
    <input type="hidden" name="end_date" value="{{ request.args.get('end_date', '') }}">
    <input type="hidden" name="date_range" value="{{ request.args.get('date_range', '') }}">
</div>


                <!-- Filter Buttons -->
                <!-- <div class="bug-filter-actions">
                    <button type="submit" class="modern-btn apply-btn bug-filter-btn">
                        <span class="btn-icon">🔍</span>
                        <span class="btn-text">Apply Bug Filters</span>
                    </button>
                    <button type="reset" class="modern-clear-btn bug-clear-btn">
                        <span class="btn-icon">🗑️</span>
                        <span class="btn-text">Clear</span>
                    </button>
                </div> -->
            </div>
        </form>
    </div>

    <!-- Bug Data Table -->
    <div class="bug-table-container">
        <div class="bug-table-wrapper">
            <table class="bug-table">
                <thead class="bug-table-header">
                    <tr>
                        <th class="bug-table-th">bug_id</th>
                        <th class="bug-table-th">JIRA Project</th>
                        <th class="bug-table-th">Project Category</th>
                        <th class="bug-table-th">build_version</th>
                        <th class="bug-table-th">Occurrence</th>
                        <th class="bug-table-th">Status</th>
                        <th class="bug-table-th">Priority</th>
                        <th class="bug-table-th">test_case</th>
                        <th class="bug-table-th">Age (in days)</th>
                        <th class="bug-table-th">Platform</th>
                        <th class="bug-table-th">l1 category</th>
                        <th class="bug-table-th">OOSLA?</th>
                        <th class="bug-table-th"># failures</th>
                    </tr>
                </thead>
                <tbody class="bug-table-body">
                    {% for bug in bugs %}
                    <tr class="bug-table-row">
                        <td class="bug-table-cell bug-id">{{ bug.bug_id }}</td>
                        <td class="bug-table-cell">{{ bug.jira_project }}</td>
                        <td class="bug-table-cell">{{ bug.project_category }}</td>
                        <td class="bug-table-cell">{{ bug.build_version }}</td>
                        <td class="bug-table-cell">{{ bug.occurrence }}</td>
                        <td class="bug-table-cell status-{{ bug.status|lower|replace(' ', '-') }}">{{ bug.status }}</td>
                        <td class="bug-table-cell priority-{{ bug.priority|lower }}">{{ bug.priority }}</td>
                        <td class="bug-table-cell test-case">{{ bug.test_case }}</td>
                        <td class="bug-table-cell age">{{ bug.age }}</td>
                        <td class="bug-table-cell">{{ bug.platform }}</td>
                        <td class="bug-table-cell">{{ bug.l1_category }}</td>
                        <td class="bug-table-cell oosla-{{ bug.oosla|lower }}">{{ bug.oosla }}</td>
                        <td class="bug-table-cell failures">{{ bug.failures }}</td>
                    </tr>
                    {% endfor %}

                    {% if not bugs %}
                    <tr class="bug-table-row empty-row">
                        <td class="bug-table-cell" colspan="13">No bug data available</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

    {# Base query parameters to persist other filters #}
{% set base_args = {
    'project_category_name': request.args.get('project_category_name', ''),
    'project_name': request.args.get('project_name', ''),
    'build_version': request.args.get('build_version', ''),
    'latest_release': request.args.get('latest_release', ''),
    'lob': request.args.get('lob', ''),
    'app_platform': request.args.get('app_platform', ''),
    'os_version': request.args.get('os_version', ''),
    'start_date': request.args.get('start_date', ''),
    'end_date': request.args.get('end_date', ''),
    'date_range': request.args.get('date_range', ''),
    'scenarioname': request.args.get('scenarioname', ''),
    'test_case': request.args.get('test_case', ''),
    'l1_category':request.args.get('l1_category', ''),
    'bug_per_page': bug_per_page
} %}

           

 <div class="table-pagination">
  <span class="pagination-info">
    Page {{ bug_current_page }} of {{ pages }}
  </span>

  <div class="pagination-controls">
    {% if bug_current_page > 1 %}
      {% set prev_args = base_args.copy() %}
      {% set _ = prev_args.update({'bug_page': bug_current_page - 1}) %}
      <a href="{{ request.path }}?{{ prev_args | urlencode }}" onclick="showSpinner()">« Prev</a>
    {% endif %}

    {% if bug_current_page < pages %}
      {% set next_args = base_args.copy() %}
      {% set _ = next_args.update({'bug_page': bug_current_page + 1}) %}
      <a href="{{ request.path }}?{{ next_args | urlencode }}" onclick="showSpinner()">Next »</a>
    {% endif %}
  </div>
</div>


            </div>
        </div>
    </div>
</div>


<script>
  function showSpinner() {
    // Implement spinner logic here if you want
    console.log('Form submitted, spinner can show now');
  }
</script>


<!-- Spinner Overlay -->
<div id="spinnerOverlay">
  <div class="spinner"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("filterForm");
    const spinnerOverlay = document.getElementById("spinnerOverlay");
    const clearBtn = document.getElementById("clearDates");
    const dateRange = document.getElementById("date_range");
    const startDateInput = document.getElementById("start_date");
    const endDateInput = document.getElementById("end_date");

    function submitWithLoader() {
      spinnerOverlay.classList.add("active");
      form.submit();
    }

    // ✅ Calculate last 30 days' start and end dates
    const today = new Date();
    const last30Start = new Date(today);
    last30Start.setDate(today.getDate() - 29); // 30 days including today
    const last30End = today;

    // Check if dates are already selected (from query params)
    const selectedStart = "{{ request.args.get('start_date', '') }}";
    const selectedEnd = "{{ request.args.get('end_date', '') }}";

    flatpickr("#date_range", {
      mode: "range",
      dateFormat: "Y-m-d",
      defaultDate: selectedStart && selectedEnd
        ? [selectedStart, selectedEnd]
        : [last30Start, last30End],
      onClose: function (selectedDates, dateStr, instance) {
        // Only submit if a new valid range is picked (2 dates)
        if (selectedDates.length === 2) {
          startDateInput.value = instance.formatDate(selectedDates[0], "Y-m-d");
          endDateInput.value = instance.formatDate(selectedDates[1], "Y-m-d");
          submitWithLoader();
        }
        // If user closes without picking, do nothing (no reload)
      }
    });

    // Ensure hidden inputs reflect current selection on load
    if (selectedStart && selectedEnd) {
      startDateInput.value = selectedStart;
      endDateInput.value = selectedEnd;
    }

    // Clear button functionality
    clearBtn.addEventListener("click", function () {
      dateRange._flatpickr.clear();
      startDateInput.value = "";
      endDateInput.value = "";
      submitWithLoader();
    });

    // Reset all filters
    const resetBtn = document.getElementById('resetAllFilters');
    if (resetBtn) {
      resetBtn.addEventListener('click', function(){
        // Clear Select2 multiselects
        ['latest_release','build_version','lob','app_platform','os_version','scenarioname','test_case'].forEach(id => {
          const el = $('#'+id);
          if (el.length) {
            el.val(null).trigger('change');
          }
        });
        // Clear date range
        if (dateRange && dateRange._flatpickr) dateRange._flatpickr.clear();
        startDateInput.value = '';
        endDateInput.value = '';
        // Reset pages to 1
        const fp = document.getElementById('feature_page'); if (fp) fp.value = 1;
        const tp = document.getElementById('test_method_page'); if (tp) tp.value = 1;
        const bp = document.getElementById('bug_page'); if (bp) bp.value = 1;
        // Submit
        spinnerOverlay.classList.add('active');
        form.submit();
      });
    }

    // Auto-submit for dropdowns
    // For standard change events (fallback if Select2 not initialized)
    form.querySelectorAll("select").forEach(el => {
      el.addEventListener("change", function(){
        spinnerOverlay.classList.add("active");
        form.submit();
      });
    });

    window.addEventListener("load", () => {
      spinnerOverlay.classList.remove("active");
    });
  });
  // Sync multiselects from feature/test forms into main filterForm then submit once
  function syncAndSubmitToMain(e) {
    if (e && e.preventDefault) e.preventDefault();
    const mainForm = document.getElementById('filterForm');
    const hiddenContainer = document.getElementById('hiddenMultiFilters');
    const spinnerOverlay = document.getElementById('spinnerOverlay');
    if (!mainForm || !hiddenContainer) return;

    hiddenContainer.innerHTML = '';

    // copy scenarioname selections
    const scenSelect = document.getElementById('scenarioname');
    if (scenSelect) {
      Array.from(scenSelect.selectedOptions).forEach(opt => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'scenarioname';
        input.value = opt.value;
        hiddenContainer.appendChild(input);
      });
    }

    // copy test_case selections
    const testSelect = document.getElementById('test_case');
    if (testSelect) {
      Array.from(testSelect.selectedOptions).forEach(opt => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'test_case';
        input.value = opt.value;
        hiddenContainer.appendChild(input);
      });
    }

    // Ensure existing main filters that are multi-select also send all values
    ['latest_release','build_version','lob','app_platform','os_version'].forEach(id => {
      const sel = document.getElementById(id);
      if (sel) {
        Array.from(sel.selectedOptions).forEach(opt => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = id;
          input.value = opt.value;
          hiddenContainer.appendChild(input);
        });
      }
    });

    // Keep existing start/end dates
    const sd = document.getElementById('start_date');
    const ed = document.getElementById('end_date');
    if (sd && sd.value) {
      const i = document.createElement('input');
      i.type = 'hidden'; i.name = 'start_date'; i.value = sd.value; hiddenContainer.appendChild(i);
    }
    if (ed && ed.value) {
      const i = document.createElement('input');
      i.type = 'hidden'; i.name = 'end_date'; i.value = ed.value; hiddenContainer.appendChild(i);
    }

    // show loader and submit
    if (spinnerOverlay) spinnerOverlay.classList.add('active');
    mainForm.submit();
  }
</script>


<script>
  // Auto-submit for Feature Wise filter
  document.getElementById('scenarioname').addEventListener('change', function() {
    document.getElementById('featureForm').submit();
  });

  // Auto-submit for Test Method Wise filter
  document.getElementById('test_case').addEventListener('change', function() {
    document.getElementById('testMethodForm').submit();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Handle pagination link clicks with loader
    document.querySelectorAll(".pagination-controls a").forEach(link => {
      link.addEventListener("click", function (e) {
        document.getElementById("spinnerOverlay").classList.add("active");
      });
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("bugfilterForm");  
    const spinnerOverlay = document.getElementById("spinnerOverlay");

    function submitWithLoader() {
      spinnerOverlay.classList.add("active");
      form.submit();
    }

    // Auto-submit for dropdowns
    form.querySelectorAll("select").forEach(el => {
      el.addEventListener("change", submitWithLoader);
    });

    // Pagination links show spinner
    document.querySelectorAll(".pagination-controls a").forEach(link => {
      link.addEventListener("click", function () {
        spinnerOverlay.classList.add("active");
      });
    });
  });
</script>
<script>
  $(document).ready(function() {
    // Initialize for scenarioname (Feature filter)
    $('#scenarioname').select2({
      placeholder: "Select a feature",
      allowClear: true,
      dropdownAutoWidth: true,      
      width: 'resolve'
    });

    // Initialize for test_case (Test Method filter)
    $('#test_case').select2({
      placeholder: "Select a test method",
      allowClear: true
    });
    // Main filters as multiselect Select2
    $('#latest_release, #build_version, #lob, #app_platform, #os_version').select2({
      placeholder: "Select",
      allowClear: true,
      width: 'resolve',
      closeOnSelect: false
    });
    // Ensure bug filter build version behaves like others
    $('#bug_build_version').select2({
      placeholder: "All Builds",
      allowClear: true,
      width: 'resolve'
    });
    // Debounced submit to reduce loading issues
    let submitTimeout;
    function debouncedSubmit() {
      clearTimeout(submitTimeout);
      submitTimeout = setTimeout(() => {
        $('#spinnerOverlay').addClass('active');
        $('#filterForm')[0].submit();
      }, 300); // Wait 300ms after last selection
    }
    
    // Do not submit on open/close; submit only on actual selection changes (handled below)
    
    // Keep debounced submit for scenarioname and test_case (they have their own forms)
    $('#scenarioname, #test_case').on('select2:select select2:unselect', debouncedSubmit);
    // Ensure previous selections remain when changing others
    // $('#latest_release, #build_version, #lob, #app_platform, #os_version, #scenarioname, #test_case').on('select2:select select2:unselect', debouncedSubmit);
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const copyBtn = document.getElementById("copyLinkBtn");
    if (copyBtn) {
        copyBtn.addEventListener("click", function () {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert("Link copied to clipboard:\n" + url);
            }).catch(err => {
                alert("Failed to copy link: " + err);
            });
        });
    }
});
</script>

<script>
  const left = document.querySelectorAll('.table-scroll')[0];
  const right = document.querySelectorAll('.table-scroll')[1];

  left.addEventListener('scroll', () => {
    right.scrollTop = left.scrollTop;
  });
  right.addEventListener('scroll', () => {
    left.scrollTop = right.scrollTop;
  });
</script>


<script>
          // Sync Status Management
        function closeSyncBanner() {
            const banner = document.getElementById('syncStatusBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
    
        
        function updateSyncStatus(statusData) {
            const banner = document.getElementById('syncStatusBanner');
            const progressFill = document.getElementById('syncProgressFill');
            const syncDetails = document.getElementById('syncDetails');
            document.getElementById('lastUpdated').textContent = statusData.timestamp || '';
            
            if (!banner) return;
            
            if (statusData.is_sync_in_progress) {
                banner.className = 'sync-status-banner sync-in-progress';
                banner.style.display = 'block';
                
                // Update progress if available
                if (statusData.sync_status && statusData.sync_status.length > 0) {
                    const activeSync = statusData.sync_status.find(s => s.status === 'in_progress');
                    if (activeSync && progressFill) {
                        progressFill.style.width = `${activeSync.progress_percentage || 0}%`;
                    }
                    
                    // Update details
                    if (syncDetails) {
                        syncDetails.innerHTML = statusData.sync_status.map(s => 
                            `<span class="sync-detail-item">${s.sync_type}: ${s.message || 'In progress...'}</span>`
                        ).join('');
                    }
                }
            } else {
                // Don't show completed sync banner - just hide it
                banner.style.display = 'none';
            }
            
            // Update nav status indicator
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.status-text');
            
            if (statusIndicator && statusText) {
                if (statusData.is_sync_in_progress) {
                    statusIndicator.className = 'status-indicator status-syncing';
                    statusText.textContent = 'Syncing';
                } else {
                    statusIndicator.className = 'status-indicator status-ready';
                    statusText.textContent = 'Ready';
                }
            }
        }
        
        function checkSyncStatus() {
            const fetchUrl = buildApiUrl('/api/sync_status');
            
            fetch(fetchUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Sync status API response:', data);  // <-- Debug line
                    updateSyncStatus(data);
                })
                .catch(error => {
                    console.error('Error checking sync status:', error);
                });
        }
        
        // Check sync status every 30 seconds
        function startSyncStatusMonitoring() {
            // Initial check
            checkSyncStatus();
            
            // Set up periodic checking
            setInterval(checkSyncStatus, 30000); // Check every 30 seconds
        }
        
        // Start monitoring when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startSyncStatusMonitoring);
        } else {
            startSyncStatusMonitoring();
        }
    </script>
</script>
<!-- <script>
  $(document).ready(function () {
    $('#latest_release, #build_version, #lob, #app_platform, #os_version, #scenarioname').on('select2:close', function () {
      $('#spinnerOverlay').addClass('active');
      $('#filterForm')[0].submit();
    });
  });
</script> -->

<script>
  $(document).ready(function () {
    // All filter elements including date input
    const $filters = $('#latest_release, #build_version, #lob, #app_platform, #os_version, #scenarioname, #date_range');

    // When user clicks anywhere on the page
    $(document).on('click', function (e) {
      // Check if the click happened outside the filter area
      if (!$(e.target).closest('.select2-container, .modern-date-container').length && 
          !$(e.target).is($filters)) {
        // Show spinner and submit only once user clicks outside
        $('#spinnerOverlay').addClass('active');
        $('#filterForm')[0].submit();
      }
    });
  });
</script>


<script>
$(document).ready(function () {
    $('.pagination-btn').on('click', function () {
        const targetPage = $(this).data('target-page');
        const pageType = $(this).data('page-type');  // feature_page or test_method_page
        $('#' + pageType).val(targetPage);

        $('#spinnerOverlay').addClass('active');
        $('#filterForm').submit();
    });
});
</script>


<!-- <script>
  $(document).ready(function () {
    $('#latest_release, #build_version, #lob, #app_platform, #os_version, #scenarioname').on('change', function () {
      $('#filterForm').submit();
    });
  });
</script> -->

</body>
</html>


